{
  "hash": "c24d9c69e72bacfac3eb934026d5f309",
  "result": {
    "markdown": "# Student grades example\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/grades.png){fig-align='center' width=20%}\n:::\n:::\n\nIn this section we are going to go through analysing datasets of students grades. \n\n## The student grades data\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/data.png){fig-align='center' width=15%}\n:::\n:::\n\n\nDownload the five following files into your directory \"Chapter_20-21\".\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<a href=\"https://m-gemmell.github.io/R_for_everyone/downloads/student_grades_group_A.tsv\">\n<button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download student_grades_group_A.tsv</button>\n</a>\n```\n:::\n:::\n\n<br>\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<a href=\"https://m-gemmell.github.io/R_for_everyone/downloads/student_grades_group_B.tsv\">\n<button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download student_grades_group_B.tsv</button>\n</a>\n```\n:::\n:::\n\n<br>\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<a href=\"https://m-gemmell.github.io/R_for_everyone/downloads/student_grades_group_C.tsv\">\n<button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download student_grades_group_C.tsv</button>\n</a>\n```\n:::\n:::\n\n<br>\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<a href=\"https://m-gemmell.github.io/R_for_everyone/downloads/student_grades_group_D.tsv\">\n<button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download student_grades_group_D.tsv</button>\n</a>\n```\n:::\n:::\n\n<br>\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<a href=\"https://m-gemmell.github.io/R_for_everyone/downloads/student_grades_group_E.tsv\">\n<button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download student_grades_group_E.tsv</button>\n</a>\n```\n:::\n:::\n\n<br>\n\nThese files contain the marks secured by USA students in various subjects. The files are separated by anonymised race/ethnicity (groups A-E). \n\nThe files each contain the columns:\n\n- __gender__: female or male.\n- __parental level of education__: some high school, high school, associate's degree, some college, bachelor's degree, or master's degree.\n- __lunch__: Whether the student ate free/reduced lunches or standard lunches.\n- __test preparation course__: Whether the student completed a test prep course (completed) or not (none).\n- __math score__: The student's math score.\n- __reading score__: The student's reading score.\n- __writing score__: The student's writing score.\n\nSource of data: https://www.kaggle.com/spscientist/students-performance-in-exams\n\n## Analysis script\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/hashtag2.png){fig-align='center' width=20%}\n:::\n:::\n\nBefore carrying on I would suggest to set your working directory into the directory \"Chapter_20-21\".\n\nNow create a new R Script and save it as \"student_grades.R\" in the \"Chapter_20-21\" directory. It is useful to have your scripts close to their relevant data.\n\nEnsure you use annotations and code sections to keep your script organised and tidy.\n\nOne extra tip: I normally like to keep a `setwd()` command at the top of my R Scripts so the script will set itself to the correct working directory. I just copy the relevant command from the __console__.\n\n## Reading in and preprocessing the data\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/r_read.png){fig-align='center' width=20%}\n:::\n:::\n\nWe are going to first read in the data and carry out some changes to it. First we'll carry this out on just the group A data.\n\nRead in the group A TSV (tab separated value) file:\n\n::: {.cell}\n\n```{.r .cell-code}\ngroup_a_df <- read.csv(\"student_grades_group_A.tsv\",\n                       sep = \"\\t\",\n                       stringsAsFactors = TRUE,\n                       check.names = FALSE)\n```\n:::\n\n\nWhen you first read in a file it is always good practice to check the resulting __data frame's__ contents:\n\n::: {.cell}\n\n```{.r .cell-code}\n#Check the top 5 rows\nhead(group_a_df)\n#View the data frame\nView(group_a_df)\n#Summary of each of its columns\nsummary(group_a_df)\n```\n:::\n\n\nThere are three main things we want to do with this __data frame__:\n\n- Change the column names so spaces are underscores. We can carry this out with `gsub()`.\n- Change the order of the levels for the column \"parental level of education\" so they are in order from least to most education. We can do this with the `factor()` __function__.\n- Add a group column which will contain the information on what race/ethnicity group each student belongs to. This will contain all the same info for this __data frame__ but it will be useful later on. We are happy for it to be a __character__ column for now.\n\nLet us carry out these tasks:\n\n::: {.cell}\n\n```{.r .cell-code}\n#Change spaces to _ in column names\ncolnames(group_a_df) <- gsub(pattern = \" \", \n                             replacement = \"_\",\n                             x = colnames(group_a_df))\n#check our change\ncolnames(group_a_df)\n\n#Change the order of the parental level of education levels\nedu_level_order <- c(\"some high school\",\"high school\",\n                     \"associate's degree\",\"some college\",\n                     \"bachelor's degree\",\"master's degree\")         \ngroup_a_df$parental_level_of_education <- factor(\n  group_a_df$parental_level_of_education,\n  levels = edu_level_order\n)\n#check our change\nlevels(group_a_df$parental_level_of_education)\n\n#Add group column using the recycle rule\ngroup_a_df[,\"group\"] <- \"group_A\"\n#check the new column\ngroup_a_df$group\n```\n:::\n\n\nGreat we have created code to __read__ in our file and preprocess the __data frame__. We have checked the output and know it produces the __data frame__ in the format we want.\n\nWe could copy and paste the code four times and change the relevant __variable names__ to __read__ in groups B-E. This would be pretty annoying and time consuming though.\n\nInstead let us create a __function__ to do this for us. This will mostly use the same code above with __variable names__ changed. There are a few changes though especially for the \"group_name\"\" column creation.\n\n__Note__: The __variable names__ used within the __function__ should not be the same as any you are using outside the __function__.\n\n::: {.cell}\n\n```{.r .cell-code}\n#Function name: \"read_and_preprocess\"\n#Input: file_name\nread_and_preprocess <- function(file_name){\n  #read in the file\n  df <- read.csv(file_name, sep = \"\\t\",\n                 stringsAsFactors = TRUE, check.names = FALSE)\n  #column name change\n  colnames(df) <- gsub(pattern = \" \", replacement = \"_\", x = colnames(df))\n  #Parental level of education order\n  edu_level_order <- c(\"some high school\",\"high school\",\n                       \"associate's degree\",\"some college\",\n                       \"bachelor's degree\",\"master's degree\")         \n  df$parental_level_of_education <- \n    factor(df$parental_level_of_education, levels = edu_level_order)\n  #extract the group name from the file name\n  group_name <- gsub(\".*_group\",\"group\", file_name)\n  group_name <- gsub(\".tsv\",\"\", group_name)\n  #Add group column\n  df$group <- group_name\n  #Return df\n  return(df)\n}\n```\n:::\n\n\nWe have created the ___function__. Now to run it with all our files:\n\n::: {.cell}\n\n```{.r .cell-code}\n#We can specify the option name\n#This is useful when we have lots of options\ngroup_a_df <- read_and_preprocess(file_name = \"student_grades_group_A.tsv\")\n#But we don't need to, which is useful with less options\ngroup_b_df <- read_and_preprocess(\"student_grades_group_B.tsv\")\ngroup_c_df <- read_and_preprocess(\"student_grades_group_C.tsv\")\ngroup_d_df <- read_and_preprocess(\"student_grades_group_D.tsv\")\ngroup_e_df <- read_and_preprocess(\"student_grades_group_E.tsv\")\n```\n:::\n\n\n## Combining the data frames\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/combine.png){fig-align='center' width=20%}\n:::\n:::\n\nA lot of the time we have multiple files but we want all the data to be in one __data frame__.\n\nThe first step is to create a __list__ containing our __data frames__. A __list__ is just like a __vector__ except it can hold heterogeneous data (multiple classes) whilst a __vector__ can only contain homogeneous data (one class).\n\nWe will use this so we can __loop__ over our __data frames__. There is more to __lists__, if you would like to see more check out: https://rc2e.com/datastructures#intro-DataStructures\n\nWe'll start with creating our __list__ then using a __for loop__ to print out the first 3 rows of each __data frame__. To create a __list__ of __data frames__ we use the __function__ `list()` just like we would with `c()`.\n\n::: {.cell}\n\n```{.r .cell-code}\n#Create list\ndf_lst <- list(group_a_df, group_b_df, group_c_df, group_d_df, group_e_df)\n#Loop through list\nfor (df in df_lst) {\n  #Print the first element of the group name column\n  print(df$group[1])\n  #Print the first 3 rows\n  print(head(x = df, n = 3))\n}\n```\n:::\n\n\nWith our __list__ we can combine the __data frames__ into one __data frame__ with a __for loop__ and `rbind()`.\n\nIt would be very simple but `rbind()` will not function if one of the __data frames__ provided does not exist. We will therefore use an __if statement__ to create a __data frame__ for our combined data in the first loop.\n\nWe will use a new function, `exists()`. It will return `TRUE` if the provided __variable__ exists and `FALSE` if it does not. The provided __variable name__ needs to be a character (a string in quotes in this case).\n\n::: {.cell}\n\n```{.r .cell-code}\n#First ensure the variable we want to create does not exist\nrm(student_grades_df)\n#Now to loop through our list\nfor (df in df_lst) {\n  #If statment using the exists() function\n  #If the variable student_grades_df exists\n  if (exists(\"student_grades_df\")) {\n    #Combine student_grades_df with df by rows\n    student_grades_df <- rbind(student_grades_df, df)\n  } else {\n    #else if it doesn't exist assign df as student_grades_df\n    student_grades_df <- df\n  }\n}\n\n#whilst we are here let us change the group column to a factor now\n#No need to change the order as we are happy with it being alphabetical\nstudent_grades_df$group <- factor(student_grades_df$group)\n```\n:::\n\n\n## Saving the data frame\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/r_save.png){fig-align='center' width=15%}\n:::\n:::\n\n\nYou can write the new __data frame__ to a text file. This is good if you want to use the file outside of R. \n\nWhat if you want to save a R __object__ so you can use it later without having to run all the script you used to create it or __reading__ in a file you created?\n\nYou can use the `save()` function:\n\n::: {.cell}\n\n```{.r .cell-code}\nsave(student_grades_df, file = \"student_grades_df\")\n```\n:::\n\n\nThe above created a file called \"students_grades_df\" that is not human-readable. It contains the __data frame__ `student_grades_df`. The name of the file and __variable__ do not have to match but I find it easier if they do.\n\nYou can then load in the file which will load the __variable__ with its __variable name__. Before we load the data we will remove our current `student_grades_df` __object__:\n\n::: {.cell}\n\n```{.r .cell-code}\n#Remove the data frame\nrm(student_grades_df)\n#Load in the data frame\nload(\"student_grades_df\")\n```\n:::\n\n\nSaving your R __objects__ acts as very good checkpoints after code that takes a long time to run.\n\n## Scaling & Grading\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/letter_grades.png){fig-align='center' width=20%}\n:::\n:::\n\nWe currently have the base scores (%) for the students but not their letter grade (A,B,C, or F in this case).\n\nBefore we provide the grades we are go to scale each student's results. There are complicated ways to do this but we will get the mean score for each topic (math, writing, and reading). For each score below the mean we will minus 5 and for each score above will will add 5. Scores equal to the mean will not be affected.\n\n::: {.cell}\n\n```{.r .cell-code}\n#Create function to scale score vector\nscale_score <- function(score_vec){\n  #Get mean score which we will round to 0 decimal places\n  mean_score <- round(mean(score_vec), digits = 0)\n  #Create an empty scale_score_vec to add to\n  scale_score_vec <- c()\n  #Loop through scores to scale them\n  for (i in 1:length(score_vec)) {\n    score <- score_vec[i]\n    #if to add 5 if larger than mean\n    if (score > mean_score) { score <- score + 5 }\n    #if to minus 5 if lower than mean\n    if (score < mean_score) { score <- score - 5 }\n    #We don't add or minus anything if the score is equal to the mean\n    #Add the scaled score to the scale_score_vec\n    scale_score_vec <- c(scale_score_vec, score)\n  }\n  #Return the created vector\n  return(scale_score_vec)\n}\n\n#Run the function on the topics to create new scaled score topics\nstudent_grades_df$math_scaled_score <- \n  scale_score(student_grades_df$math_score)\nstudent_grades_df$reading_scaled_score <- \n  scale_score(student_grades_df$reading_score)\nstudent_grades_df$writing_scaled_score <- \n  scale_score(student_grades_df$writing_score)\n```\n:::\n\n\nNow we have scaled the scores. Some students now have more than 100% and some have less than 0% but that is fine. It doesn't matter for their final grade.\n\nWe will give out grades based on the scaled scores like so:\n\n- __A__: >=95%\n- __B__: >=80% and <95%\n- __C__: >=60% and <80%\n- __F__: <60%\n\nWe can carry this out with the below code. To create it I copied the last code block and altered it. This time we use `else if` so the subsequent __ifs__ only work if all the previous __ifs__ were `FALSE`.\n\n::: {.cell}\n\n```{.r .cell-code}\n#Create function to grade a vector\ngrade_score <- function(score_vec){\n  #Create empty grade_vec to add to\n  grade_vec <- c()\n  #Loop through scores to scale them\n  for (i in 1:length(score_vec)) {\n    #get current score\n    score <- score_vec[i]\n    #if statements with else ifs\n    if (score >= 95) {\n      grade_vec[i] <- \"A\"\n    } else if (score >= 80) {\n      grade_vec[i] <- \"B\"\n    } else if (score >= 60) {\n      grade_vec[i] <- \"C\"\n    } else {\n      grade_vec[i] <- \"F\"\n    }\n  }\n  #Return the created vector as a factor\n  return(factor(grade_vec))\n}\n#Run the function on the topics to create the grade columns\nstudent_grades_df$math_grade <- \n  grade_score(student_grades_df$math_scaled_score)\nstudent_grades_df$reading_grade <- \n  grade_score(student_grades_df$reading_scaled_score)\nstudent_grades_df$writing_grade <- \n  grade_score(student_grades_df$writing_scaled_score)\n```\n:::\n\n\nThat is he last edit we will do to our __data frame__ so lets __save__ it.\n\n::: {.cell}\n\n```{.r .cell-code}\nsave(student_grades_df, file = \"student_grades_df\")\n```\n:::\n\n\n## Some quick plots\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/bar_chart.png){fig-align='center' width=20%}\n:::\n:::\n\nBelow are some quick plots with their code.\n\n::: {.cell}\n\n:::\n\n\nFirst let us see the distribution of grades for the three topics:\n\n::: {.cell}\n\n```{.r .cell-code}\n#Math\n#With plot()\nplot(table(student_grades_df$math_grade))\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#With barplot()\nbarplot(table(student_grades_df$math_grade))\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Reading\n#With barplot()\nbarplot(table(student_grades_df$reading_grade))\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Writing\n#With barplot()\nbarplot(table(student_grades_df$writing_grade))\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\nIt seems the grades are pretty low. Maybe that is to do with our scaling and harsh grading.\n\nQuickly we'll check the histogram of all the scores and all the scaled scores.\n\n::: {.cell}\n\n```{.r .cell-code}\n#scores\nhist(\n  c(student_grades_df$math_score, \n    student_grades_df$reading_score,\n    student_grades_df$writing_score\n  )\n)\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#scaled scores\nhist(\n  c(student_grades_df$math_scaled_score, \n    student_grades_df$reading_scaled_score,\n      student_grades_df$writing_scaled_score\n  )\n)\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\nWe can see a big dip in the middle of the scaled scores but not in the non-scaled scores. Seems scaling just increased the distance between people who did better than others.\n\nLast thing is we'll create a boxplot of math scores separating the x axis by some metadata.\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot(\n  math_score~test_preparation_course+lunch,\n  data = student_grades_df)\n```\n\n::: {.cell-output-display}\n![](21-Student_grades_example_files/figure-html/unnamed-chunk-33-1.png){width=960}\n:::\n:::\n\n\nI think that is plenty of coding for today and for this course. Thank you very much!\n\n## Tips for creating your own loops and functions\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](figures/tip_box.png){fig-align='center' width=20%}\n:::\n:::\n\nBefore you go here are some quick tips.\n\n- Create the code outside the __loop/function__ to begin with.\n- Test with a small __object__ to start (e.g. a part of a __data frame__).\n- Keep backups of code.\n- If you encounter errors try running your code step by step to determine where the error is.\n- It can useful to run the code inside your __loop/function__ by setting the __loop/function variable__ (e.g. `i <- 1`)\n",
    "supporting": [
      "21-Student_grades_example_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/font-awesome-5.13.0/css/all.min.css\" rel=\"stylesheet\" />\r\n<link href=\"site_libs/font-awesome-5.13.0/css/v4-shims.min.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}